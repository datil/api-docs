<h1 id='configuracion'>Configuración</h1>
<p>Link utiliza archivos de configuración en formato .ini que contienen todos los
parámetros que se pueden ajustar. Puesto que los archivos de configuración se
encuentran en la carpeta de <code>C:\Archivos de Progama\Datil\Link\config</code> para
editarlos debes abrir siempre tu editor con permisos de administrador.</p>

<p>Los <a href="https://es.wikipedia.org/wiki/INI_(extensi%C3%B3n_de_archivo)">archivos INI</a>
están compuestos por secciones y cada sección puede tener varias claves y
valores.</p>
<h2 id='base-de-datos'>Base de datos</h2>
<p>Cómo lo describimos en la sección de <em>Introducción</em> Link utiliza una tabla de
control para mantener un registro de los documentos que ya ha procesado. Este
registro contiene información como el estado, la fecha de registro en la tabla
de control, la fecha y el número de autorización y el ID (id_externo) del
documento en Datil.</p>

<p>En el archivo <a href="#environment-ini">environment.ini</a> va la configuración de la
conexión a la base donde se encuentran las tablas de control y mensaje.
En el archivo <a href="#companies-my_company-ini">companies/my company.ini</a> debes
configurar la conexión a la base de datos donde están las tablas/vistas desde
las que Link extraerá la información de los documentos.</p>

<p>Esta separación permite a Link funcionar en estos escenarios:
- Emitir documentos de más de una compañía en un sistema ERP que almacena los
documentos de cada compañía en una base de datos diferente.
- Mantener la base de datos en la que puede <em>escribir</em> Link completamente aislada
de la base de datos de la que sólo puede <em>leer</em> Link.</p>

<p>A partir de la versión <a href="#6-0-0">6.0.0</a> existen dos maneras de especificar los
parámetros de conexión a la base de datos:</p>
<h3 id='simplificada'>Simplificada</h3>
<p>Link tiene la capacidad de construir la cadena de conexión para los siguientes
drivers ODBC: SQL Anywhere 11, Microsoft ODBC for Oracle, Oracle in OraClient11g_home1,
Microsoft ODBC Driver for Oracle, SQL Server y Access ODBC Driver. Si utilizas alguno de estos drivers
debes especificar los siguientes parámetros:</p>

<table><thead>
<tr>
<th>Parámetros</th>
<th>&nbsp;</th>
</tr>
</thead><tbody>
<tr>
<td>driver</td>
<td>Controlador cuando se establece una conexión por ODBC.</td>
</tr>
<tr>
<td>server</td>
<td>Dirección o nombre del servidor</td>
</tr>
<tr>
<td>name</td>
<td>Nombre de la base de datos</td>
</tr>
<tr>
<td>user</td>
<td>Nombre de usuario.</td>
</tr>
<tr>
<td>password</td>
<td>Contraseña del usuario de la base de datos</td>
</tr>
<tr>
<td>version<p class="dt-data-param-required">requerido</p></td>
<td>Versión del motor de base de datos que se utiliza para constriur SQL dependiendo de la versión</td>
</tr>
<tr>
<td>connection_string</td>
<td>Permite especificar la cadena de conexión ODBC para conectarse a la base. Si especificas este parámetro todos los otros parámetros de conexión como driver, server, name, user y password serán ignorados. Debes especificar este parámetro o el conjunto de parámetros driver, server, name, user, password.</td>
</tr>
<tr>
<td>api<p class="dt-data-param-required">requerido</p></td>
<td>Puede ser <code>odbc</code> o <code>adodb</code></td>
</tr>
<tr>
<td>data_source<p class="dt-data-param-required">requerido</p></td>
<td>Utilizado para conexiones tipo <code>adodb</code></td>
</tr>
<tr>
<td>provider<p class="dt-data-param-required">requerido</p></td>
<td>Utilizado para conexiones tipo <code>adodb</code></td>
</tr>
<tr>
<td>datetime_format</td>
<td>Formato de la representación literal de un SQL_TIMESTAMP. Por ejemplo en SQL Server el literal de un <code>DATETIME</code> es %Y-%m-%d %H:%M:%S</td>
</tr>
</tbody></table>
<h3 id='cadena-de-conexion-connection-string-explicita'>Cadena de conexión (connection string) explícita</h3>
<p>La nueva manera a partir de la versión 6.0.0 de conexión sólo requiere que se
especifique el parámetro <code>connection_string</code>. Así es posible utilizar cualquier
motor de base de datos o controlador no soportado por la manera simplificada de
conexión.</p>

<p>Esta es la manera de conexión recomendada a partir de la versión 6.0.0 de Link.</p>
<h4 id='ejemplos'>Ejemplos</h4>
<p>Ejemplos de configuración para sistemas de base de datos más comunes</p>
<h5 id='sql-server'>SQL Server</h5><pre class="highlight ini tab-ini"><code><span class="py">driver</span> <span class="p">=</span> <span class="s">SQL Server</span>
<span class="py">server</span> <span class="p">=</span> <span class="s">ADMIN</span><span class="se">\S</span><span class="s">QLEXPRESS.</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">DATIL</span>
<span class="py">user</span> <span class="p">=</span> <span class="s">link</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">Link007</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">2012</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">odbc</span>
<span class="py">datasource</span> <span class="p">=</span> <span class="s">None</span>
<span class="py">provider</span>   <span class="p">=</span> <span class="s">None</span>
</code></pre><h5 id='oracle'>Oracle</h5><pre class="highlight ini tab-ini"><code><span class="nn">[DatabaseSource]</span>
<span class="py">driver</span> <span class="p">=</span> <span class="s">Microsoft ODBC for Oracle</span>
<span class="py">server</span> <span class="p">=</span> <span class="s">mydbserver</span>
<span class="py">name</span> <span class="p">=</span>
<span class="py">user</span> <span class="p">=</span> <span class="s">link</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">datil</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">10</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">odbc</span>
<span class="py">data_source</span> <span class="p">=</span> <span class="s">None</span>
<span class="py">provider</span> <span class="p">=</span> <span class="s">None</span>
<span class="py">datetime_format</span> <span class="p">=</span> <span class="s">%Y-%m-%d %H:%M:%S.%f'</span>
</code></pre><h5 id='mysql'>MySQL</h5><pre class="highlight ini tab-ini"><code><span class="nn">[DatabaseSource]</span>
<span class="py">connection_string</span> <span class="p">=</span> <span class="s">DRIVER={MySQL ODBC 8.0 ANSI Driver};SERVER=localhost;DATABASE=datil;USER=link;PASSWORD=Link007;OPTION=3</span>
<span class="py">driver</span> <span class="p">=</span>
<span class="py">server</span> <span class="p">=</span>
<span class="py">name</span> <span class="p">=</span>
<span class="py">user</span> <span class="p">=</span>
<span class="py">password</span> <span class="p">=</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">8.0</span>
<span class="py">api</span> <span class="p">=</span> <span class="s">odbc</span>
<span class="py">data_source</span> <span class="p">=</span> <span class="s">None</span>
<span class="py">provider</span> <span class="p">=</span> <span class="s">None</span>
</code></pre>
<p>Consulta la documentación del driver ODBC que utilizas, o busca en la sitio web
<a href="https://www.connectionstrings.com">www.connectionstrings.com</a> la documentación
del motor de base de datos que utilizas.</p>
<h2 id='environment-ini'>environment.ini</h2>
<p>Parámetros generales del ambiente. Contiene las siguientes secciones.</p>
<h3 id='databasesource'>[DatabaseSource]</h3>
<p>Revisa la sección de configuración de <a href="#base-de-datos">base de datos</a> para más
información</p>
<h3 id='scheduler'>[Scheduler]</h3>
<p>Las tareas de emisión, consulta y sincronización se ejecutan al iniciar el
servicio y luego esperan el tiempo establecido por estos parámetros antes de
volver a ejecutarse. Todos estos valores se especifican en segundos.</p>

<table><thead>
<tr>
<th>Parámetros</th>
<th>&nbsp;</th>
</tr>
</thead><tbody>
<tr>
<td>issue_receipts_interval<p class="dt-data-param-required">requerido</p></td>
<td>Intervalo para la tarea de <em>emisión</em> de documentos.</td>
</tr>
<tr>
<td>read_receipts_interval<p class="dt-data-param-required">requerido</p></td>
<td>Intervalo para la tarea de <em>consulta de estado</em> de documentos.</td>
</tr>
<tr>
<td>issue_receipts_from_xml_interval<p class="dt-data-param-required">requerido</p></td>
<td>Intervalo para la tarea de <em>emisión por xml</em>.</td>
</tr>
<tr>
<td>send_status_interval<p class="dt-data-param-required">requerido</p></td>
<td>Intervalo para la tarea de reporte de estado (aun no utilizada)</td>
</tr>
<tr>
<td>sync_resources_interval<p class="dt-data-param-required">requerido</p></td>
<td>Intervalo para la tarea de <em>sincronización de recursos</em>.</td>
</tr>
</tbody></table>
<h3 id='constraints'>[Constraints]</h3>
<p>Restricciones para la consulta de documentos.</p>

<table><thead>
<tr>
<th>Parámetros</th>
<th>&nbsp;</th>
</tr>
</thead><tbody>
<tr>
<td>issue_limit<p class="dt-data-param-required">requerido</p></td>
<td>Número máximo de documentos que la tarea de <em>emisión</em> de documentos toma cada vez que se ejecuta. Existe un problema conocido en bases de datos ORACLE que impide establecer este parámetro en un valor diferente a uno.</td>
</tr>
<tr>
<td>issue_order<p class="dt-data-param-required">requerido</p></td>
<td>Determina el ordenamiento de los documentos consultados para emitir. Puede ser <code>ASC</code> o <code>DESC</code></td>
</tr>
<tr>
<td>get_info_limit<p class="dt-data-param-required">requerido</p></td>
<td>Número máximo de documentos que la tarea de <em>consulta de estado</em> de documentos toma cada vez que se ejecuta.</td>
</tr>
<tr>
<td>get_info_order<p class="dt-data-param-required">requerido</p></td>
<td>Determina el ordenamiento de los documentos consultados para obtener su estado. Puede ser <code>ASC</code> o <code>DESC</code></td>
</tr>
<tr>
<td>first_receipt_date<p class="dt-data-param-required">requerido</p></td>
<td>Establece la fecha a partir de la cual necesitas emitir documentos. La fecha debe tener el formato <code>YYYY-mm-dd hh:MM:SS</code> ejemplo: <code>2002-09-12 13:40:00</code> para el 12 de septiembre del año 2002 a las trece horas con cuarenta minutos y cero segundos.</td>
</tr>
<tr>
<td>max_days_to_query<p class="dt-data-param-required">requerido</p></td>
<td>El número máximo de días previos a consultar a partir de la fecha actual. Normalmente se configura con 30 puesto que es el límite de fecha de emisión establecido por el SRI para emitir un documento electrónico.</td>
</tr>
<tr>
<td>new_receipts_limit<p class="dt-data-param-required">requerido</p></td>
<td>Número máximo de documentos que la tarea de <em>control</em> inserta a la tabla de Control cada vez que se ejecuta.</td>
</tr>
</tbody></table>
<h2 id='companies-my_company-ini'>companies/my_company.ini</h2>
<p>Recomendamos renombrar este archivo con un nombre
corto de tu empresa, sobretodo si vas a utilizar una instalación de Link para
varias empresas. Link utiliza el nombre de este archivo para garantizar que los
registros en la tabla de <em>control</em> sean únicos para cada compañía, esto es lo
que verás en el campo <code>company_name</code> una vez que Link empiece a funcionar e
inserte registros en la tabla de control.
Utiliza sólo letras, números, guiones o sub-guiones para el nombre del archivo.
Ejemplo: <code>acme_inc</code></p>
<h3 id='general'>[General]</h3>
<p>En la sección <code>[General]</code> configura el parámetro <code>ruc</code> con el ruc de la empresa.</p>
<h3 id='api'>[Api]</h3>
<p>En la sección <code>[Api]</code> configura el parámetro <code>xkey</code> con el <em>API key</em> de Dátil y
<code>xpassword</code> con la clave del certificado de firma electrónica, <code>environment</code>
con el valor <code>1</code> para emisión en modo de pruebas o <code>2</code> para emitir en producción.</p>
<h3 id='issuefromdatabase'>[IssueFromDatabase]</h3>
<p>Los parámetros de esta sección te permiten encender o apagar la <em>tarea de emisión</em>
desde la base de datos para cada tipo de comprobante para esta compañía. Los
posibles valores para estos parámetros son <code>yes</code> o <code>no</code>. El valor <code>yes</code> le
indica a Link que debe encender la tarea y <code>no</code> que debe apagarla.</p>
<h3 id='issuefromxml'>[IssueFromXml]</h3>
<p>Estos parámetros permiten encender o apagar la <em>tarea de emisión por xml</em>.</p>
<h3 id='read'>[Read]</h3>
<p>Estos parámetros permiten encender o apagar la <em>tarea de consulta</em> de
autorización.</p>
<h3 id='databasesource-2'>[DatabaseSource]</h3>
<p>Revisa la sección de configuración de <a href="#base-de-datos">base de datos</a> para más
información.</p>
<h3 id='xmlsource'>[XmlSource]</h3>
<p>Configuración de las rutas de los directorios donde se encuentran los archivos
XML. Esto aplica para la emisión por XML.</p>
<h3 id='sincronizacion-y-eventos'>Sincronización y Eventos</h3>
<p>Link tiene la habilidad de suscribirse a <a href="https://datil.dev/next/events">eventos</a>
emitidos por Datil y ejecutar sentencias SQL y descargar archivos. Cualquier
atributo del evento que contenga la dirección a un recurso (URI) válido puede
ser descargado y almacenado en un directorio del sistema.</p>

<p>El nombre de la sección para cada configuración es el nombre del evento, de
esta manera podrás tener configuraciones diferentes para cada evento.</p>

<p>Estos son los parámetros de configuración para cada evento:</p>

<table><thead>
<tr>
<th>Parámetros</th>
<th>&nbsp;</th>
</tr>
</thead><tbody>
<tr>
<td>download_files<p class="dt-data-param-required">requerido</p></td>
<td>Activa o inactiva el proceso de descarga de archivos. Puede ser <em>yes</em> o <em>no</em></td>
</tr>
<tr>
<td>update_tables<p class="dt-data-param-required">requerido</p></td>
<td>Activa o inactiva el proceso de ejecución de SQL. Puede ser <em>yes</em> o <em>no</em></td>
</tr>
<tr>
<td>formats_to_download<p class="dt-data-param-required">requerido</p></td>
<td>Especifica este valor si <code>download_files</code> está activo. Puede ser una lista de valores separados por coma o la palabra reservada <em>all</em>. Si utilizas la palabra <em>all</em> intentará descargar los archivos detallados en este mismo parámetro en la sección [Sync] del archivo environment.ini</td>
</tr>
<tr>
<td>download_path</td>
<td>Ruta del directorio donde se descargará los archivos. Requerido si <code>download_files</code> está activo.</td>
</tr>
<tr>
<td>download_path_[ATRIBUTO]</td>
<td>Ruta del directorio donde se descargarán los archivos para el atributo <em>&quot;ATRIBUTO&quot;</em>. Puedes personalizar esta ruta utilizando condicionales, lazos, macros, bloques, variables, etiquetas disponibles en <a href="http://jinja.pocoo.org/">Jinja2</a>.</td>
</tr>
<tr>
<td>update_tables_sentences</td>
<td>Sentencias SQL a ejecutar cuando el evento sea recibido. Puedes personalizar este SQL utilizando condicionales, lazos, macros, bloques, variables disponibles en <a href="http://jinja.pocoo.org/">Jinja2</a>. Requerido si <code>update_tables</code> está activo.</td>
</tr>
</tbody></table>

<h4 class="dt-section">Ejemplo de descarga en un solo directorio</h4>
<pre class="highlight ini tab-ini"><code><span class="nn">[invoice.received]</span>
<span class="py">download_files</span> <span class="p">=</span> <span class="s">yes</span>
<span class="py">update_tables</span> <span class="p">=</span> <span class="s">yes</span>
<span class="py">formats_to_download</span> <span class="p">=</span> <span class="s">printable_version_url, electronic_document_url</span>
<span class="py">download_path</span> <span class="p">=</span> <span class="s">C:/Documentos Recibidos/</span>
<span class="py">update_tables_sentences</span> <span class="p">=</span> <span class="s">UPDATE factura</span>
  <span class="err">SET</span> <span class="py">numero_autorizacion</span> <span class="p">=</span> <span class="s">'{{ authorization.number }}'</span>
  <span class="err">WHERE</span> <span class="py">numero</span> <span class="p">=</span> <span class="s">'{{ number }}'</span>
</code></pre>
<p>De esta manera podrías, por ejemplo, actualizar información en una tabla de tu
base de datos y descargar el PDF (<code>printable_version_url</code>) y el documento
electrónico XML (<code>electronic_document_url</code>) cada vez que en tu cuenta Dátil
recibas una factura de compra (invoice.received). La configuración luciría así:</p>

<h4 class="dt-section">Ejemplo de descarga con un directorio diferente para cada archivo</h4>
<pre class="highlight ini tab-ini"><code><span class="nn">[invoice.received]</span>
<span class="py">download_files</span> <span class="p">=</span> <span class="s">yes</span>
<span class="py">update_tables</span> <span class="p">=</span> <span class="s">yes</span>
<span class="py">formats_to_download</span> <span class="p">=</span> <span class="s">printable_version_url, electronic_document_url</span>
<span class="py">download_path_printable_version_url</span> <span class="p">=</span> <span class="s">C:/Documentos Recibidos/{{ issue_date_date.year }}/{{ issue_date_month_name }}/pdf/</span>
<span class="py">download_path_electronic_document_url</span> <span class="p">=</span> <span class="s">C:/Documentos Recibidos/{{ issue_date_date.year }}/{{ issue_date_month_name }}/xml/</span>
<span class="py">update_tables_sentences</span> <span class="p">=</span> <span class="s">UPDATE factura</span>
  <span class="err">SET</span> <span class="py">numero_autorizacion</span> <span class="p">=</span> <span class="s">'{{ authorization.number }}'</span>
  <span class="err">WHERE</span> <span class="py">numero</span> <span class="p">=</span> <span class="s">'{{ number }}'</span>
</code></pre>
<p>Si quisieras almacenar los archivos en directorios separados podrías configurar
el evento de esta manera.</p>

<aside class="notice">
El nombre del archivo tomará el nombre establecido por el servidor del
archivo a través de la cabecera HTTP Content-Disposition. Si esta cabecera no
está presente, se utilizará el ID del recurso contenido en el evento para dar
nombre al archivo.
</aside>
<h2 id='actualizacion-de-estados'>Actualización de estados</h2>
<p>Link es capaz de ejecutar sentencias SQL basado en el estado de autorización del comprobante. Se puede de configurar el query <code>on_status_update</code> dentro del archivo de configuración del comprobante para almacenar información de autorización u otra información que se desee del documento en la base de datos. Este query se ejecutará cada vez que el comprobante esté en estado <code>POR AUTORIZAR</code> y <code>RECIBIDO</code>.</p>

<p>Ejemplo para guardar información de autorización para facturas</p>
<pre class="highlight sql tab-sql"><code>  <span class="n">on_status_update</span><span class="o">=</span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">RESPUESTA_SRI_FACTURAS</span> <span class="p">(</span>
    <span class="n">id</span><span class="p">,</span>
    <span class="n">numero_documento</span><span class="p">,</span>
    <span class="n">clave_acceso</span><span class="p">,</span>
    <span class="n">fecha_autorizacion</span> 
  <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span>
    <span class="err">{{</span> <span class="n">id</span> <span class="err">}}</span><span class="p">,</span>
    <span class="err">{{</span> <span class="n">autorizacion</span><span class="p">.</span><span class="n">numero</span> <span class="err">}}</span><span class="p">,</span>
    <span class="err">{{</span> <span class="n">clave_acceso</span> <span class="err">}}</span><span class="p">,</span>
    <span class="err">{{</span> <span class="n">autorizacion</span><span class="p">.</span><span class="n">fecha</span> <span class="err">}}</span>
  <span class="p">)</span>
</code></pre><h1 id='operacion'>Operación</h1>
<p>En el menú <code>Inicio</code> buscar el <code>Simbolo del Sistema</code> , darle click derecho y escoger la opción <code>Ejecutar como administrador</code>.</p>

<p>Luego para iniciar el servicio ejecutar el comando:</p>

<p><code>net start datilink</code></p>

<p>Enter.</p>

<p>Si desea detener el servicio, ejecutar:</p>

<p><code>net stop datilink</code></p>
